<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Reminder Dashboard - Vispera AR</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f3f2f1;
            min-height: 100vh;
            color: #323130;
        }

        /* Header - Outlook Style */
        .header {
            padding: 0 16px;
            background: #0078d4;
            height: 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header h1 {
            font-size: 1rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .header-date {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 48px);
        }

        /* Left Sidebar - Navigation */
        .sidebar {
            width: 200px;
            background: #1b1b1f;
            padding: 8px 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-item {
            padding: 10px 16px;
            color: #d1d1d1;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.15s;
        }

        .sidebar-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .sidebar-item.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .sidebar-item svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
        }

        .sidebar-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 8px 0;
        }

        .sidebar-section {
            padding: 8px 16px 4px;
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-count {
            margin-left: auto;
            background: #0078d4;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .sidebar-count.urgent {
            background: #d13438;
        }

        /* Left Panel - Customer List */
        .left-panel {
            width: 380px;
            min-width: 380px;
            border-right: 1px solid #e1dfdd;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e1dfdd;
            background: #faf9f8;
        }

        .panel-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #323130;
            margin-bottom: 12px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid #8a8886;
            border-radius: 2px;
            background: white;
            color: #323130;
            font-size: 0.85rem;
        }

        .search-box input:focus {
            outline: none;
            border-color: #0078d4;
        }

        .search-box input::placeholder { color: #a19f9d; }

        .search-box svg {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            stroke: #605e5c;
        }

        .filters-row {
            display: flex;
            gap: 4px;
            margin-top: 12px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #8a8886;
            border-radius: 2px;
            background: white;
            color: #323130;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .filter-btn:hover { background: #f3f2f1; }
        .filter-btn.active { background: #0078d4; color: white; border-color: #0078d4; }
        .filter-btn.overdue.active { background: #d13438; border-color: #d13438; }
        .filter-btn.today.active { background: #ffaa44; border-color: #ffaa44; color: #323130; }
        .filter-btn.upcoming.active { background: #0078d4; border-color: #0078d4; }

        /* Customer List */
        .customer-list {
            flex: 1;
            overflow-y: auto;
        }

        .customer-item {
            padding: 12px 16px;
            border-bottom: 1px solid #edebe9;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .customer-item:hover {
            background: #f3f2f1;
        }

        .customer-item.selected {
            background: #deecf9;
        }

        .customer-item.active {
            background: #c7e0f4;
            border-left: 3px solid #0078d4;
        }

        .customer-item.excluded {
            opacity: 0.5;
        }

        .customer-checkbox {
            margin-top: 2px;
        }

        .customer-checkbox input {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #0078d4;
        }

        .customer-info {
            flex: 1;
            min-width: 0;
        }

        .customer-name-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }

        .customer-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #323130;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .customer-amount {
            font-weight: 600;
            font-size: 0.9rem;
            color: #323130;
            white-space: nowrap;
        }

        .customer-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 4px;
            font-size: 0.75rem;
            color: #605e5c;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .status-overdue { background: #fde7e9; color: #a4262c; }
        .status-today { background: #fff4ce; color: #8a6914; }
        .status-upcoming { background: #deecf9; color: #0078d4; }

        .reminder-badge {
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 0.7rem;
            background: #f3f2f1;
            color: #605e5c;
        }

        .customer-invoices {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #edebe9;
            display: none;
        }

        .customer-item.expanded .customer-invoices {
            display: block;
        }

        .invoice-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.8rem;
            color: #605e5c;
        }

        .expand-toggle {
            font-size: 0.75rem;
            color: #0078d4;
            cursor: pointer;
            margin-top: 4px;
        }

        .expand-toggle:hover {
            text-decoration: underline;
        }

        /* Summary Footer */
        .list-footer {
            padding: 12px 16px;
            border-top: 1px solid #e1dfdd;
            background: #faf9f8;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        .summary-label { color: #605e5c; }
        .summary-value { font-weight: 600; color: #323130; }
        .summary-value.tl { color: #107c10; }
        .summary-value.usd { color: #0078d4; }
        .summary-value.eur { color: #8764b8; }

        /* Right Panel - Email Preview */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #faf9f8;
        }

        .preview-toolbar {
            padding: 8px 16px;
            border-bottom: 1px solid #e1dfdd;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-btn {
            padding: 6px 12px;
            border: 1px solid #8a8886;
            border-radius: 2px;
            background: white;
            color: #323130;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toolbar-btn:hover { background: #f3f2f1; }
        .toolbar-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .toolbar-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
        }

        .nav-counter {
            font-size: 0.85rem;
            color: #605e5c;
            padding: 0 12px;
        }

        /* Email Form */
        .preview-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .email-card {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border: 1px solid #e1dfdd;
            border-radius: 2px;
        }

        .email-header {
            padding: 16px;
            border-bottom: 1px solid #e1dfdd;
        }

        .email-field {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .email-field:last-child { margin-bottom: 0; }

        .email-label {
            width: 80px;
            font-size: 0.8rem;
            color: #605e5c;
            padding-top: 8px;
            flex-shrink: 0;
        }

        .email-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e1dfdd;
            border-radius: 2px;
            font-size: 0.9rem;
            color: #323130;
            background: #faf9f8;
        }

        .email-input:focus {
            outline: none;
            border-color: #0078d4;
            background: white;
        }

        .email-input.readonly {
            background: #f3f2f1;
            color: #605e5c;
        }

        /* CC Tags */
        .cc-container {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 6px 8px;
            border: 1px solid #e1dfdd;
            border-radius: 2px;
            background: #faf9f8;
            min-height: 36px;
            align-items: center;
        }

        .cc-container:focus-within {
            border-color: #0078d4;
            background: white;
        }

        .cc-tag {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #deecf9;
            border-radius: 2px;
            font-size: 0.8rem;
            color: #0078d4;
        }

        .cc-tag button {
            background: none;
            border: none;
            color: #605e5c;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            padding: 0;
        }

        .cc-tag button:hover { color: #d13438; }

        .cc-input {
            flex: 1;
            min-width: 120px;
            border: none;
            background: transparent;
            font-size: 0.85rem;
            outline: none;
            padding: 4px;
        }

        /* Template Selection */
        .template-section {
            padding: 16px;
            border-bottom: 1px solid #e1dfdd;
            background: #faf9f8;
        }

        .template-label {
            font-size: 0.8rem;
            color: #605e5c;
            margin-bottom: 8px;
        }

        .template-buttons {
            display: flex;
            gap: 8px;
        }

        .template-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #e1dfdd;
            border-radius: 2px;
            background: white;
            cursor: pointer;
            transition: all 0.15s;
            text-align: center;
        }

        .template-btn:hover { background: #f3f2f1; }

        .template-btn.active {
            border-color: #0078d4;
            background: #deecf9;
        }

        .template-btn.soft.active { border-color: #107c10; background: #dff6dd; }
        .template-btn.firm.active { border-color: #ffaa44; background: #fff4ce; }
        .template-btn.final.active { border-color: #d13438; background: #fde7e9; }

        .template-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: #323130;
        }

        .template-desc {
            font-size: 0.7rem;
            color: #605e5c;
            margin-top: 2px;
        }

        /* Email Body */
        .email-body {
            padding: 16px;
        }

        .email-body-label {
            font-size: 0.8rem;
            color: #605e5c;
            margin-bottom: 8px;
        }

        .email-textarea {
            width: 100%;
            min-height: 300px;
            padding: 12px;
            border: 1px solid #e1dfdd;
            border-radius: 2px;
            font-size: 0.9rem;
            font-family: 'Segoe UI', sans-serif;
            line-height: 1.5;
            resize: vertical;
            color: #323130;
        }

        .email-textarea:focus {
            outline: none;
            border-color: #0078d4;
        }

        .modified-indicator {
            display: inline-block;
            padding: 2px 6px;
            background: #fff4ce;
            color: #8a6914;
            font-size: 0.7rem;
            border-radius: 2px;
            margin-left: 8px;
        }

        /* Customer Note */
        .note-section {
            padding: 12px 16px;
            background: #fff4ce;
            border-top: 1px solid #e1dfdd;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: #8a6914;
        }

        .note-edit-btn {
            padding: 4px 8px;
            border: 1px solid #8a6914;
            border-radius: 2px;
            background: transparent;
            color: #8a6914;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .note-content {
            font-size: 0.85rem;
            color: #323130;
            margin-top: 4px;
        }

        .note-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #8a6914;
            border-radius: 2px;
            font-size: 0.85rem;
            margin-top: 8px;
        }

        /* Buttons */
        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 2px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-primary {
            background: #0078d4;
            color: white;
        }

        .btn-primary:hover {
            background: #106ebe;
        }

        .btn-primary:disabled {
            background: #c8c6c4;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: #323130;
            border: 1px solid #8a8886;
        }

        .btn-secondary:hover {
            background: #f3f2f1;
        }

        .btn-danger {
            background: #d13438;
            color: white;
        }

        .btn-danger:hover {
            background: #a4262c;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #605e5c;
            text-align: center;
            padding: 40px;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            stroke: #c8c6c4;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            color: #323130;
            margin-bottom: 8px;
        }

        /* Loading */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e1dfdd;
            border-top-color: #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            border-radius: 2px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            max-width: 450px;
            width: 90%;
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e1dfdd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #323130;
        }

        .modal-close {
            background: none;
            border: none;
            color: #605e5c;
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover { color: #323130; }

        .modal-body {
            padding: 20px;
            color: #323130;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e1dfdd;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Report View */
        .report-container {
            display: none;
            padding: 40px;
            max-width: 700px;
            margin: 0 auto;
        }

        .report-container.active { display: block; }

        .report-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .report-icon {
            width: 64px;
            height: 64px;
            background: #107c10;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .report-icon svg {
            width: 32px;
            height: 32px;
            stroke: white;
            stroke-width: 3;
        }

        .report-icon.error { background: #d13438; }

        .report-title {
            font-size: 1.5rem;
            color: #323130;
            margin-bottom: 8px;
        }

        .report-subtitle { color: #605e5c; }

        .report-section {
            background: white;
            border: 1px solid #e1dfdd;
            border-radius: 2px;
            margin-bottom: 16px;
        }

        .report-section-title {
            padding: 12px 16px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #605e5c;
            background: #faf9f8;
            border-bottom: 1px solid #e1dfdd;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .report-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid #edebe9;
        }

        .report-item:last-child { border-bottom: none; }

        .report-item-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .report-item-icon.success { background: #dff6dd; color: #107c10; }
        .report-item-icon.error { background: #fde7e9; color: #d13438; }

        .report-item-content { flex: 1; }
        .report-item-name { font-weight: 600; color: #323130; }
        .report-item-detail { font-size: 0.8rem; color: #605e5c; }

        .report-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { display: none; }
            .left-panel { width: 320px; min-width: 320px; }
        }

        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .left-panel { width: 100%; max-height: 40vh; }
            .right-panel { max-height: 60vh; }
        }
    </style>
</head>
<body>
    <!-- Main Dashboard -->
    <div id="dashboardView">
        <div class="header">
            <div class="header-left">
                <h1>üìß Invoice Reminder Dashboard</h1>
            </div>
            <div class="header-actions">
                <span class="header-date" id="dateDisplay"></span>
                <button class="btn btn-primary" id="sendAllBtn" onclick="showConfirmModal()">
                    Send <span id="selectedCountHeader">0</span> Emails
                </button>
            </div>
        </div>

        <div class="main-container">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-item active">
                    <svg viewBox="0 0 24 24" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    Dashboard
                </div>
                <div class="sidebar-divider"></div>
                <div class="sidebar-section">Status</div>
                <div class="sidebar-item" onclick="setFilter('overdue')">
                    <svg viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    Overdue
                    <span class="sidebar-count urgent" id="sidebarOverdue">0</span>
                </div>
                <div class="sidebar-item" onclick="setFilter('today')">
                    <svg viewBox="0 0 24 24" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    Due Today
                    <span class="sidebar-count" id="sidebarToday">0</span>
                </div>
                <div class="sidebar-item" onclick="setFilter('upcoming')">
                    <svg viewBox="0 0 24 24" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                    Upcoming
                    <span class="sidebar-count" id="sidebarUpcoming">0</span>
                </div>
                <div class="sidebar-divider"></div>
                <div class="sidebar-item" onclick="setFilter('all')">
                    <svg viewBox="0 0 24 24" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    All Customers
                    <span class="sidebar-count" id="sidebarAll">0</span>
                </div>
            </div>

            <!-- Left Panel - Customer List -->
            <div class="left-panel">
                <div class="panel-header">
                    <div class="panel-title">Customers</div>
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="searchInput" placeholder="Search by name or email..." oninput="filterCustomers()">
                    </div>
                    <div class="filters-row">
                        <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
                        <button class="filter-btn overdue" data-filter="overdue" onclick="setFilter('overdue')">Overdue</button>
                        <button class="filter-btn today" data-filter="today" onclick="setFilter('today')">Today</button>
                        <button class="filter-btn upcoming" data-filter="upcoming" onclick="setFilter('upcoming')">Upcoming</button>
                    </div>
                </div>

                <div class="customer-list" id="customerList">
                    <div class="loading-state" id="listLoading">
                        <div class="spinner"></div>
                        <p>Loading customers...</p>
                    </div>
                </div>

                <div class="list-footer">
                    <div class="summary-row">
                        <span class="summary-label">Selected (<span id="selectedCount">0</span>)</span>
                    </div>
                    <div class="summary-row" style="margin-top: 8px;">
                        <span class="summary-value tl" id="summaryTL" style="display:none">0 TL</span>
                        <span class="summary-value usd" id="summaryUSD" style="display:none">$0</span>
                        <span class="summary-value eur" id="summaryEUR" style="display:none">‚Ç¨0</span>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Email Preview -->
            <div class="right-panel">
                <div class="preview-toolbar">
                    <div class="toolbar-left">
                        <button class="toolbar-btn" id="prevBtn" onclick="navigateCustomer(-1)">
                            <svg viewBox="0 0 24 24" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                            Previous
                        </button>
                        <span class="nav-counter" id="previewCounter">0 / 0</span>
                        <button class="toolbar-btn" id="nextBtn" onclick="navigateCustomer(1)">
                            Next
                            <svg viewBox="0 0 24 24" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        </button>
                    </div>
                    <div>
                        <button class="toolbar-btn" onclick="resetCurrentEmail()">
                            <svg viewBox="0 0 24 24" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                            Reset
                        </button>
                    </div>
                </div>

                <div class="preview-content" id="previewContent">
                    <div class="empty-state" id="emptyPreview">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"/>
                        </svg>
                        <h3>Select a customer</h3>
                        <p>Click on a customer from the list to preview and edit their reminder email.</p>
                    </div>

                    <div class="email-card" id="emailCard" style="display: none;">
                        <div class="email-header">
                            <div class="email-field">
                                <label class="email-label">To:</label>
                                <input type="text" class="email-input readonly" id="emailTo" readonly>
                            </div>
                            <div class="email-field">
                                <label class="email-label">CC:</label>
                                <div class="cc-container" id="ccContainer">
                                    <input type="email" class="cc-input" id="ccInput" placeholder="Add CC and press Enter" onkeydown="handleCCKeydown(event)">
                                </div>
                            </div>
                            <div class="email-field">
                                <label class="email-label">Subject:</label>
                                <input type="text" class="email-input" id="emailSubject" oninput="markAsModified()">
                            </div>
                        </div>

                        <div class="template-section">
                            <div class="template-label">Template <span class="modified-indicator" id="modifiedIndicator" style="display:none">Modified</span></div>
                            <div class="template-buttons">
                                <button class="template-btn soft" data-template="soft" onclick="setTemplate('soft')">
                                    <div class="template-name">Soft</div>
                                    <div class="template-desc">1st reminder</div>
                                </button>
                                <button class="template-btn firm" data-template="firm" onclick="setTemplate('firm')">
                                    <div class="template-name">Firm</div>
                                    <div class="template-desc">2nd-3rd reminder</div>
                                </button>
                                <button class="template-btn final" data-template="final" onclick="setTemplate('final')">
                                    <div class="template-name">Final</div>
                                    <div class="template-desc">Last notice</div>
                                </button>
                            </div>
                        </div>

                        <div class="email-body">
                            <div class="email-body-label">Message</div>
                            <textarea class="email-textarea" id="emailBody" oninput="markAsModified()"></textarea>
                        </div>

                        <div class="note-section" id="noteSection" style="display:none">
                            <div class="note-header">
                                <span class="note-title">‚ö†Ô∏è Customer Note</span>
                                <button class="note-edit-btn" id="noteEditBtn" onclick="toggleNoteEdit()">Edit</button>
                            </div>
                            <div class="note-content" id="noteContent"></div>
                            <input type="text" class="note-input" id="noteInput" style="display:none" placeholder="Add a note..." onblur="saveNote()" onkeydown="if(event.key==='Enter')saveNote()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report View -->
    <div class="report-container" id="reportView">
        <div class="report-header">
            <div class="report-icon" id="reportIcon">
                <svg viewBox="0 0 24 24" fill="none"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
            <h2 class="report-title" id="reportTitle">Emails Sent Successfully</h2>
            <p class="report-subtitle" id="reportSubtitle"></p>
        </div>

        <div class="report-section">
            <div class="report-section-title">Email Results</div>
            <div id="reportEmailResults"></div>
        </div>

        <div class="report-section">
            <div class="report-section-title">Sheet Updates</div>
            <div id="reportSheetResults"></div>
        </div>

        <div class="report-actions">
            <button class="btn btn-secondary" onclick="exportReport()">Export Report</button>
            <button class="btn btn-primary" onclick="location.reload()">Done</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Send</h3>
                <button class="modal-close" onclick="hideConfirmModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>You are about to send <strong id="confirmCount">0</strong> reminder emails.</p>
                <p style="margin-top: 12px; color: #605e5c; font-size: 0.9rem;">Please make sure you have reviewed all emails before sending.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideConfirmModal()">Cancel</button>
                <button class="btn btn-primary" onclick="sendAllEmails()">Send Emails</button>
            </div>
        </div>
    </div>

    <!-- Sending Modal -->
    <div class="modal-overlay" id="sendingModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Sending Emails</h3>
            </div>
            <div class="modal-body" style="text-align: center; padding: 32px;">
                <div class="spinner" style="margin: 0 auto 16px;"></div>
                <p id="sendingStatus">Sending emails...</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const WEBHOOK_URL = 'https://smartozzehir.app.n8n.cloud/webhook/invoice-dashboard';
        
        // ============================================
        // STATE
        // ============================================
        let customers = [];
        let selectedCustomerIndex = -1;
        let currentFilter = 'all';
        let emailEdits = {};

        // ============================================
        // TEMPLATES - with proper HTML tables
        // ============================================
        const templates = {
            soft: {
                tr: {
                    subject: '√ñdeme Hatƒ±rlatmasƒ± - Yakla≈üan Vade Tarihi',
                    bodyIntro: `Sayƒ±n {hitap},

≈ûirketimiz kayƒ±tlarƒ±nda, a≈üaƒüƒ±da bilgileri yer alan fatura/faturalarƒ±nƒ±zƒ±n vade tarihinin yakla≈ütƒ±ƒüƒ±nƒ± nazik√ße hatƒ±rlatmak isteriz.`,
                    bodyOutro: `√ñdemenizi ger√ßekle≈ütirdiyseniz bu e-postayƒ± dikkate almayabilirsiniz.

Herhangi bir sorunuz olursa bizimle ileti≈üime ge√ßmekten √ßekinmeyin.

Saygƒ±larƒ±mƒ±zla,
Vispera AR Team`
                },
                en: {
                    subject: 'Payment Reminder - Upcoming Due Date',
                    bodyIntro: `Dear {hitap},

We would like to kindly remind you that the following invoice(s) are approaching their due date.`,
                    bodyOutro: `If you have already made the payment, please disregard this email.

Please don't hesitate to contact us if you have any questions.

Best regards,
Vispera AR Team`
                }
            },
            firm: {
                tr: {
                    subject: 'Vadesi Ge√ßen Faturalarƒ±nƒ±z Hakkƒ±nda',
                    bodyIntro: `Sayƒ±n {hitap},

≈ûirketimiz kayƒ±tlarƒ±nda, a≈üaƒüƒ±da detaylarƒ± yer alan fatura/faturalarƒ±nƒ±zƒ±n vadesinin ge√ßtiƒüi ve √∂demenin hen√ºz tarafƒ±mƒ±za ula≈ümadƒ±ƒüƒ± g√∂r√ºlmektedir.`,
                    bodyOutro: `√ñdemenizi en kƒ±sa s√ºrede ger√ßekle≈ütirmenizi rica ederiz.

√ñdemenizi ger√ßekle≈ütirdiyseniz bu e-postayƒ± dikkate almayabilirsiniz.

Saygƒ±larƒ±mƒ±zla,
Vispera AR Team`
                },
                en: {
                    subject: 'Overdue Invoice(s) - Payment Reminder',
                    bodyIntro: `Dear {hitap},

We would like to bring to your attention that the following invoice(s) are past due and payment has not yet been received.`,
                    bodyOutro: `We kindly request that you arrange payment at your earliest convenience.

If you have already made the payment, please disregard this email.

Best regards,
Vispera AR Team`
                }
            },
            final: {
                tr: {
                    subject: 'SON UYARI - Vadesi Ge√ßen Faturalarƒ±nƒ±z',
                    bodyIntro: `Sayƒ±n {hitap},

Daha √∂nce g√∂nderdiƒüimiz hatƒ±rlatmalara raƒümen, a≈üaƒüƒ±daki fatura/faturalarƒ±nƒ±zƒ±n √∂demesinin h√¢l√¢ tarafƒ±mƒ±za ula≈ümadƒ±ƒüƒ±nƒ± √ºz√ºlerek bildirmek isteriz.`,
                    bodyOutro: `Bu son hatƒ±rlatmamƒ±zdƒ±r. 7 i≈ü g√ºn√º i√ßinde √∂deme yapƒ±lmamasƒ± halinde, alacaƒüƒ±mƒ±zƒ±n tahsili i√ßin yasal s√ºre√ß ba≈ülatƒ±lacaktƒ±r.

√ñdemenizi derhal ger√ßekle≈ütirmenizi √∂nemle rica ederiz.

Saygƒ±larƒ±mƒ±zla,
Vispera AR Team`
                },
                en: {
                    subject: 'FINAL NOTICE - Overdue Invoice(s)',
                    bodyIntro: `Dear {hitap},

Despite our previous reminders, we regret to inform you that payment for the following invoice(s) has still not been received.`,
                    bodyOutro: `This is our final notice. If payment is not received within 7 business days, we will be forced to initiate legal proceedings for debt recovery.

We strongly urge you to settle this matter immediately.

Best regards,
Vispera AR Team`
                }
            }
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('en-US', {
            weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'
        });

        document.addEventListener('DOMContentLoaded', loadData);

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadData() {
            try {
                const response = await fetch(WEBHOOK_URL);
                if (!response.ok) throw new Error('Failed to load data');
                
                const data = await response.json();
                customers = data.customers || [];
                
                customers.forEach(c => {
                    c.selected = c.excludeFromReminders !== 'TRUE';
                    const template = suggestTemplate(c);
                    emailEdits[c.id] = {
                        cc: c.defaultCC ? c.defaultCC.split(',').map(e => e.trim()).filter(e => e) : [],
                        template: template,
                        originalTemplate: template,
                        subject: generateSubject(c, template),
                        body: generateBody(c, template),
                        originalBody: generateBody(c, template),
                        note: c.customerNote || '',
                        isModified: false
                    };
                });

                renderCustomerList();
                updateSidebar();
                updateSummary();
                document.getElementById('listLoading').style.display = 'none';

                if (customers.length > 0) {
                    selectCustomer(0);
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('listLoading').innerHTML = `
                    <div class="empty-state">
                        <p style="color: #d13438;">Failed to load data</p>
                        <p style="font-size: 0.8rem; margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            }
        }

        // ============================================
        // TEMPLATE LOGIC
        // ============================================
        function suggestTemplate(customer) {
            const emailCount = customer.emailCount || 0;
            const maxDaysOverdue = Math.max(0, ...customer.invoices.map(i => i.daysOverdue || 0));
            
            if (emailCount >= 3 || maxDaysOverdue >= 45) return 'final';
            if (emailCount >= 1 || maxDaysOverdue >= 15) return 'firm';
            return 'soft';
        }

        function generateSubject(customer, template) {
            const lang = customer.isTR ? 'tr' : 'en';
            return templates[template][lang].subject;
        }

        function generateBody(customer, template) {
            const lang = customer.isTR ? 'tr' : 'en';
            const t = templates[template][lang];
            
            let body = t.bodyIntro.replace('{hitap}', customer.hitap || customer.name);
            body += '\n\n' + generateInvoiceTableText(customer, lang);
            body += '\n\n' + t.bodyOutro;
            
            return body;
        }

        function generateInvoiceTableText(customer, lang) {
            const headers = lang === 'tr' 
                ? ['Fatura No', 'Vade Tarihi', 'Tutar', 'Durum']
                : ['Invoice No', 'Due Date', 'Amount', 'Status'];
            
            let lines = [];
            lines.push(headers.join(' | '));
            lines.push('-'.repeat(60));
            
            customer.invoices.forEach(inv => {
                let status;
                if (inv.status === 'overdue') {
                    status = lang === 'tr' ? `${inv.daysOverdue} g√ºn gecikmi≈ü` : `${inv.daysOverdue} days overdue`;
                } else if (inv.status === 'today') {
                    status = lang === 'tr' ? 'Bug√ºn' : 'Due today';
                } else {
                    status = lang === 'tr' ? `${inv.daysUntilDue} g√ºn kaldƒ±` : `${inv.daysUntilDue} days left`;
                }
                
                const amount = formatAmount(inv.amount, customer);
                lines.push(`${inv.invoiceNo || '-'} | ${inv.dueDate || '-'} | ${amount} | ${status}`);
            });
            
            return lines.join('\n');
        }

        function formatAmount(amount, customer) {
            const num = typeof amount === 'number' ? amount : parseFloat(amount) || 0;
            const formatted = num.toLocaleString(customer.isTR ? 'tr-TR' : 'en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            return formatted + ' ' + (customer.currency || (customer.isTR ? 'TL' : 'USD'));
        }

        // Generate proper HTML for email sending
        function generateEmailHTML(customer, edit) {
            const lang = customer.isTR ? 'tr' : 'en';
            const bodyLines = edit.body.split('\n');
            
            let html = '<div style="font-family: Segoe UI, Arial, sans-serif; font-size: 14px; color: #323130; line-height: 1.6;">';
            
            let inTable = false;
            let tableRows = [];
            
            bodyLines.forEach(line => {
                // Detect table header
                if (line.includes('Fatura No') || line.includes('Invoice No')) {
                    inTable = true;
                    tableRows = [];
                    return;
                }
                
                // Skip separator line
                if (line.match(/^-+$/)) return;
                
                // Table row
                if (inTable && line.includes('|')) {
                    tableRows.push(line.split('|').map(s => s.trim()));
                    return;
                }
                
                // End of table
                if (inTable && !line.includes('|') && line.trim()) {
                    html += generateHTMLTable(tableRows, customer, lang);
                    inTable = false;
                    tableRows = [];
                }
                
                // Regular paragraph
                if (!inTable) {
                    if (line.trim()) {
                        html += '<p style="margin: 0 0 12px 0;">' + escapeHtml(line) + '</p>';
                    } else {
                        html += '<br>';
                    }
                }
            });
            
            // If we ended with table
            if (inTable && tableRows.length > 0) {
                html += generateHTMLTable(tableRows, customer, lang);
            }
            
            html += '</div>';
            return html;
        }

        function generateHTMLTable(rows, customer, lang) {
            const headers = lang === 'tr' 
                ? ['Fatura No', 'Vade Tarihi', 'Tutar', 'Durum']
                : ['Invoice No', 'Due Date', 'Amount', 'Status'];
            
            let html = '<table style="border-collapse: collapse; width: 100%; max-width: 600px; margin: 16px 0; font-size: 13px;">';
            
            // Header
            html += '<thead><tr>';
            headers.forEach(h => {
                html += `<th style="border: 1px solid #e1dfdd; padding: 10px 12px; background: #f3f2f1; text-align: left; font-weight: 600; color: #323130;">${h}</th>`;
            });
            html += '</tr></thead>';
            
            // Body
            html += '<tbody>';
            rows.forEach(row => {
                html += '<tr>';
                row.forEach((cell, idx) => {
                    let style = 'border: 1px solid #e1dfdd; padding: 8px 12px; color: #323130;';
                    // Status column styling
                    if (idx === 3) {
                        if (cell.includes('gecikmi≈ü') || cell.includes('overdue')) {
                            style += ' color: #d13438; font-weight: 500;';
                        } else if (cell.includes('Bug√ºn') || cell.includes('today')) {
                            style += ' color: #8a6914; font-weight: 500;';
                        } else {
                            style += ' color: #0078d4;';
                        }
                    }
                    html += `<td style="${style}">${escapeHtml(cell)}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderCustomerList() {
            const list = document.getElementById('customerList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = customers.filter(c => {
                if (currentFilter !== 'all' && c.status !== currentFilter) return false;
                if (searchTerm && !c.name.toLowerCase().includes(searchTerm) && !c.email.toLowerCase().includes(searchTerm)) return false;
                return true;
            });

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="empty-state" style="padding: 40px;">
                        <p>No customers found</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = filtered.map(c => {
                const isSelected = c.selected !== false;
                const isActive = customers.indexOf(c) === selectedCustomerIndex;
                const isExcluded = c.excludeFromReminders === 'TRUE';
                const emailCount = c.emailCount || 0;
                const edit = emailEdits[c.id];
                const hasNote = c.customerNote || edit?.note;
                
                return `
                    <div class="customer-item ${isSelected ? 'selected' : ''} ${isActive ? 'active' : ''} ${isExcluded ? 'excluded' : ''}" 
                         data-id="${c.id}" 
                         onclick="selectCustomer(${customers.indexOf(c)})">
                        <div class="customer-checkbox" onclick="event.stopPropagation()">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} ${isExcluded ? 'disabled' : ''} 
                                   onchange="toggleCustomerSelection(${c.id}, this.checked)">
                        </div>
                        <div class="customer-info">
                            <div class="customer-name-row">
                                <span class="customer-name">${c.name}</span>
                                <span class="customer-amount">${c.amount}</span>
                            </div>
                            <div class="customer-meta">
                                <span class="status-badge status-${c.status}">
                                    ${c.status === 'overdue' ? c.daysOverdue + ' days overdue' : 
                                      c.status === 'today' ? 'Due today' : 
                                      c.daysUntilDue + ' days left'}
                                </span>
                                ${emailCount > 0 ? `<span class="reminder-badge">${emailCount}x sent</span>` : ''}
                                ${hasNote ? '<span style="color:#8a6914">üìù</span>' : ''}
                                ${isExcluded ? '<span style="color:#d13438">Excluded</span>' : ''}
                            </div>
                            <div class="expand-toggle" onclick="event.stopPropagation(); toggleExpand(${c.id})">
                                ${c.invoiceCount} invoice${c.invoiceCount > 1 ? 's' : ''} ‚ñº
                            </div>
                            <div class="customer-invoices">
                                ${c.invoices.map(inv => `
                                    <div class="invoice-row">
                                        <span>${inv.invoiceNo || '-'}</span>
                                        <span>${inv.dueDate}</span>
                                        <span>${formatAmount(inv.amount, c)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleExpand(customerId) {
            const item = document.querySelector(`.customer-item[data-id="${customerId}"]`);
            item.classList.toggle('expanded');
        }

        function updateSidebar() {
            const overdue = customers.filter(c => c.status === 'overdue').length;
            const today = customers.filter(c => c.status === 'today').length;
            const upcoming = customers.filter(c => c.status === 'upcoming').length;
            
            document.getElementById('sidebarOverdue').textContent = overdue;
            document.getElementById('sidebarToday').textContent = today;
            document.getElementById('sidebarUpcoming').textContent = upcoming;
            document.getElementById('sidebarAll').textContent = customers.length;
        }

        // ============================================
        // CUSTOMER SELECTION
        // ============================================
        function selectCustomer(index) {
            if (index < 0 || index >= customers.length) return;
            
            selectedCustomerIndex = index;
            const customer = customers[index];
            const edit = emailEdits[customer.id];
            
            renderCustomerList();

            document.getElementById('emptyPreview').style.display = 'none';
            document.getElementById('emailCard').style.display = 'block';

            document.getElementById('emailTo').value = customer.email;
            renderCCTags(edit.cc);
            setTemplateUI(edit.template);
            document.getElementById('emailSubject').value = edit.subject;
            document.getElementById('emailBody').value = edit.body;
            
            document.getElementById('modifiedIndicator').style.display = edit.isModified ? 'inline-block' : 'none';
            
            // Note section
            const note = edit.note || customer.customerNote || '';
            if (note) {
                document.getElementById('noteSection').style.display = 'block';
                document.getElementById('noteContent').textContent = note;
                document.getElementById('noteInput').value = note;
            } else {
                document.getElementById('noteSection').style.display = 'none';
            }

            updatePreviewCounter();
        }

        function navigateCustomer(direction) {
            const selectedCustomers = customers.filter(c => c.selected !== false);
            if (selectedCustomers.length === 0) return;
            
            let currentInSelected = selectedCustomers.findIndex(c => customers.indexOf(c) === selectedCustomerIndex);
            if (currentInSelected === -1) currentInSelected = 0;
            
            let newIndex = currentInSelected + direction;
            if (newIndex < 0) newIndex = selectedCustomers.length - 1;
            if (newIndex >= selectedCustomers.length) newIndex = 0;
            
            selectCustomer(customers.indexOf(selectedCustomers[newIndex]));
        }

        function updatePreviewCounter() {
            const selectedCustomers = customers.filter(c => c.selected !== false);
            const currentInSelected = selectedCustomers.findIndex(c => customers.indexOf(c) === selectedCustomerIndex);
            document.getElementById('previewCounter').textContent = `${Math.max(0, currentInSelected + 1)} / ${selectedCustomers.length}`;
            
            document.getElementById('prevBtn').disabled = selectedCustomers.length <= 1;
            document.getElementById('nextBtn').disabled = selectedCustomers.length <= 1;
        }

        // ============================================
        // CC HANDLING
        // ============================================
        function renderCCTags(ccList) {
            const container = document.getElementById('ccContainer');
            const input = document.getElementById('ccInput');
            
            container.innerHTML = '';
            ccList.forEach(email => {
                const tag = document.createElement('span');
                tag.className = 'cc-tag';
                tag.innerHTML = `${email} <button onclick="removeCC('${email}')">&times;</button>`;
                container.appendChild(tag);
            });
            container.appendChild(input);
        }

        function handleCCKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('ccInput');
                const email = input.value.trim();
                
                if (email && email.includes('@')) {
                    const customer = customers[selectedCustomerIndex];
                    if (!emailEdits[customer.id].cc.includes(email)) {
                        emailEdits[customer.id].cc.push(email);
                        renderCCTags(emailEdits[customer.id].cc);
                    }
                    input.value = '';
                }
            }
        }

        function removeCC(email) {
            const customer = customers[selectedCustomerIndex];
            emailEdits[customer.id].cc = emailEdits[customer.id].cc.filter(e => e !== email);
            renderCCTags(emailEdits[customer.id].cc);
        }

        // ============================================
        // TEMPLATE HANDLING
        // ============================================
        function setTemplate(template) {
            const customer = customers[selectedCustomerIndex];
            const edit = emailEdits[customer.id];
            
            edit.template = template;
            edit.subject = generateSubject(customer, template);
            edit.body = generateBody(customer, template);
            edit.isModified = false;
            
            setTemplateUI(template);
            document.getElementById('emailSubject').value = edit.subject;
            document.getElementById('emailBody').value = edit.body;
            document.getElementById('modifiedIndicator').style.display = 'none';
        }

        function setTemplateUI(template) {
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.template === template);
            });
        }

        function markAsModified() {
            const customer = customers[selectedCustomerIndex];
            const edit = emailEdits[customer.id];
            
            edit.subject = document.getElementById('emailSubject').value;
            edit.body = document.getElementById('emailBody').value;
            
            // Check if actually modified from original
            edit.isModified = edit.body !== edit.originalBody;
            document.getElementById('modifiedIndicator').style.display = edit.isModified ? 'inline-block' : 'none';
        }

        function resetCurrentEmail() {
            const customer = customers[selectedCustomerIndex];
            const edit = emailEdits[customer.id];
            
            edit.subject = generateSubject(customer, edit.template);
            edit.body = generateBody(customer, edit.template);
            edit.isModified = false;
            
            document.getElementById('emailSubject').value = edit.subject;
            document.getElementById('emailBody').value = edit.body;
            document.getElementById('modifiedIndicator').style.display = 'none';
        }

        // ============================================
        // NOTE HANDLING
        // ============================================
        function toggleNoteEdit() {
            const content = document.getElementById('noteContent');
            const input = document.getElementById('noteInput');
            const btn = document.getElementById('noteEditBtn');
            
            if (input.style.display === 'none') {
                content.style.display = 'none';
                input.style.display = 'block';
                input.focus();
                btn.textContent = 'Save';
            } else {
                saveNote();
            }
        }

        function saveNote() {
            const customer = customers[selectedCustomerIndex];
            const input = document.getElementById('noteInput');
            const content = document.getElementById('noteContent');
            const btn = document.getElementById('noteEditBtn');
            
            emailEdits[customer.id].note = input.value;
            content.textContent = input.value || 'No note';
            content.style.display = 'block';
            input.style.display = 'none';
            btn.textContent = 'Edit';
        }

        // ============================================
        // SELECTION & FILTERING
        // ============================================
        function toggleCustomerSelection(customerId, selected) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                customer.selected = selected;
                renderCustomerList();
                updateSummary();
                updatePreviewCounter();
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            renderCustomerList();
        }

        function filterCustomers() {
            renderCustomerList();
        }

        // ============================================
        // SUMMARY
        // ============================================
        function updateSummary() {
            const selected = customers.filter(c => c.selected !== false);
            
            let totalTL = 0, totalUSD = 0, totalEUR = 0;
            
            selected.forEach(c => {
                const amount = c.totalAmount || 0;
                const currency = c.currency || (c.isTR ? 'TL' : 'USD');
                
                if (currency === 'TL' || currency === 'TRY') totalTL += amount;
                else if (currency === 'USD') totalUSD += amount;
                else if (currency === 'EUR') totalEUR += amount;
            });

            document.getElementById('selectedCount').textContent = selected.length;
            document.getElementById('selectedCountHeader').textContent = selected.length;
            
            const summaryTL = document.getElementById('summaryTL');
            const summaryUSD = document.getElementById('summaryUSD');
            const summaryEUR = document.getElementById('summaryEUR');
            
            summaryTL.textContent = totalTL.toLocaleString('tr-TR') + ' TL';
            summaryTL.style.display = totalTL > 0 ? 'inline' : 'none';
            
            summaryUSD.textContent = '$' + totalUSD.toLocaleString('en-US');
            summaryUSD.style.display = totalUSD > 0 ? 'inline' : 'none';
            
            summaryEUR.textContent = '‚Ç¨' + totalEUR.toLocaleString('en-US');
            summaryEUR.style.display = totalEUR > 0 ? 'inline' : 'none';

            document.getElementById('sendAllBtn').disabled = selected.length === 0;
        }

        // ============================================
        // SEND EMAILS
        // ============================================
        function showConfirmModal() {
            const count = customers.filter(c => c.selected !== false && c.excludeFromReminders !== 'TRUE').length;
            document.getElementById('confirmCount').textContent = count;
            document.getElementById('confirmModal').classList.add('active');
        }

        function hideConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }

        async function sendAllEmails() {
            hideConfirmModal();
            document.getElementById('sendingModal').classList.add('active');

            const selectedCustomers = customers.filter(c => c.selected !== false && c.excludeFromReminders !== 'TRUE');
            
            // Prepare payload with HTML email bodies and custom tracking
            const payload = {
                action: 'send',
                customers: selectedCustomers.map(c => {
                    const edit = emailEdits[c.id];
                    // Determine template label with (Custom) suffix if modified
                    let templateLabel = edit.template.charAt(0).toUpperCase() + edit.template.slice(1);
                    if (edit.isModified) {
                        templateLabel += ' (Custom)';
                    }
                    
                    return {
                        ...c,
                        emailData: {
                            to: c.email,
                            cc: edit.cc,
                            subject: edit.subject,
                            body: edit.body,
                            bodyHTML: generateEmailHTML(c, edit),
                            template: templateLabel,
                            note: edit.note
                        }
                    };
                })
            };

            try {
                document.getElementById('sendingStatus').textContent = `Sending ${selectedCustomers.length} emails...`;
                
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                document.getElementById('sendingModal').classList.remove('active');
                showReport(result, selectedCustomers);
            } catch (error) {
                console.error('Error sending emails:', error);
                document.getElementById('sendingModal').classList.remove('active');
                alert('Failed to send emails: ' + error.message);
            }
        }

        // ============================================
        // REPORT
        // ============================================
        function showReport(result, selectedCustomers) {
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('reportView').classList.add('active');

            const success = result.success !== false;
            const successCount = result.successCount || selectedCustomers.length;
            const totalCount = selectedCustomers.length;

            document.getElementById('reportIcon').classList.toggle('error', !success || successCount < totalCount);
            document.getElementById('reportTitle').textContent = success ? 'Emails Sent Successfully' : 'Some Emails Failed';
            document.getElementById('reportSubtitle').textContent = `${successCount} out of ${totalCount} emails were sent`;

            const emailResults = document.getElementById('reportEmailResults');
            emailResults.innerHTML = selectedCustomers.map(c => {
                const edit = emailEdits[c.id];
                const isSuccess = !result.failures || !result.failures.includes(c.id);
                return `
                    <div class="report-item">
                        <div class="report-item-icon ${isSuccess ? 'success' : 'error'}">${isSuccess ? '‚úì' : '‚úó'}</div>
                        <div class="report-item-content">
                            <div class="report-item-name">${c.name}</div>
                            <div class="report-item-detail">${c.email}${edit.cc.length ? ' + CC: ' + edit.cc.join(', ') : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');

            const sheetResults = document.getElementById('reportSheetResults');
            const invoiceCount = selectedCustomers.reduce((sum, c) => sum + c.invoices.length, 0);
            sheetResults.innerHTML = `
                <div class="report-item">
                    <div class="report-item-icon success">‚úì</div>
                    <div class="report-item-content">
                        <div class="report-item-name">${invoiceCount} invoices updated</div>
                        <div class="report-item-detail">lastEmailSent, emailCount, lastEmailTemplate columns updated</div>
                    </div>
                </div>
            `;
        }

        function exportReport() {
            const selected = customers.filter(c => c.selected !== false);
            let csv = 'Customer,Email,Amount,Status,Template,CC\n';
            selected.forEach(c => {
                const edit = emailEdits[c.id];
                let templateLabel = edit.template;
                if (edit.isModified) templateLabel += ' (Custom)';
                csv += `"${c.name}","${c.email}","${c.amount}","${c.status}","${templateLabel}","${edit.cc.join('; ')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reminder-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>
